sudo: required
services:
  - docker
language: bash
script:
  - export BUILD_ARCH=`uname -m`
  - docker build --no-cache=true -t $DOCKER_USER/docker-magicmirror:${BUILD_ARCH}-latest .
  - docker run --rm --privileged multiarch/qemu-user-static:register --reset
  - docker run --rm -t multiarch/ubuntu-debootstrap:arm64-bionic export BUILD_ARCH=`uname -m` && docker build --no-cache=true -t $DOCKER_USER/docker-magicmirror:${BUILD_ARCH}-latest . 
  - docker run --rm -t multiarch/ubuntu-debootstrap:armhf-bionic export BUILD_ARCH=`uname -m` && docker build --no-cache=true -t $DOCKER_USER/docker-magicmirror:${BUILD_ARCH}-latest . 
after_success:
  - docker login -u="$DOCKER_USER" -p="$DOCKER_PASS"
  - docker push $DOCKER_USER/docker-magicmirror:latest
  - >
    if [[ ${BUILD_ARCH} == "armhf" ]]; then
        wget https://github.com/estesp/manifest-tool/releases/download/v0.9.0/manifest-tool-linux-armv6
        chmox +rx manifest-tool-linux-armv6
        mv manifest-tool-linux-armv6 manifest-tool
        echo "Manifest uploading ..."
        ./manifest-tool push from-spec manifest.yaml
    fi
